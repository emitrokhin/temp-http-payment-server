<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: template (~{::head}, ~{::body}, ~{::scripts})}">
<head>
    <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid #e5e5e5;
        }

        .transaction-item .left-section {
            display: flex;
            flex-direction: column;
        }

        .transaction-item .transaction-title {
            margin: 0;
            font-size: 14px;
        }

        .transaction-item .right-section {
            text-align: right;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .transaction-item .amount {
            color: #000;
        }

        .transaction-item .date-time {
            color: #777;
            font-size: 12px;
        }

        .transaction-item .middle-section .amount {
            font-size: 12px; /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç */
            color: #000; /* –û—Å—Ç–∞–≤–ª—è–µ–º —á–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        }

        .transaction-item .middle-section .status {
            font-size: 12px; /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ */
            color: #777; /* –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä—ã–º */
        }

        .transaction-item .middle-section .card-expiry {
            font-size: 12px; /* –£–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è */
            color: #000; /* –û—Å—Ç–∞–≤–ª—è–µ–º —á–µ—Ä–Ω—ã–π —Ü–≤–µ—Ç */
        }
    </style>

</head>

<body>
<div class="container mt-2">
    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    –ö–∞—Ä—Ç—ã
                </button>
            </h2>
            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <div class="cards-list" id="cardList">
                        <th:block th:if="${cards.isEmpty()}">
                            <div class="text-center">–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç</div>
                        </th:block>
                        <th:block th:each="card : ${cards}">
                            <div class="transaction-item mb-2 d-flex justify-content-between align-items-center">
                                <!-- –õ–æ–≥–æ—Ç–∏–ø –∫–∞—Ä—Ç—ã -->
                                <div class="left-section">
                                    <th:block th:if="${card.cardType == 'Visa'}">
                                        <img src="/images/visa-logo.png" alt="Visa" class="card-logo" />
                                    </th:block>
                                    <th:block th:if="${card.cardType == 'MasterCard'}">
                                        <img src="/images/mastercard-logo.png" alt="MasterCard" class="card-logo" />
                                    </th:block>
                                    <th:block th:if="${card.cardType == 'MIR'}">
                                        <img src="/images/mir-logo.png" alt="–ú–ò–†" class="card-logo" />
                                    </th:block>
                                </div>

                                <!-- –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã -->
                                <div class="middle-section">
                                    <div class="amount" th:text="'****' + ${card.cardLastFour}"></div>
                                    <!-- –°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã -->
                                    <div class="status" th:text="${card.isActive} ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ –∞–∫—Ç–∏–≤–Ω–∞'"></div>
                                </div>

                                <!-- –î–∞—Ç–∞ –∫–∞—Ä—Ç—ã -->
                                <div class="date-section">
                                    <div class="card-expiry" th:text="${card.cardExpDate}"></div>
                                </div>

                                <!-- –°—Ç—Ä–µ–ª–æ—á–∫–∞ –¥–ª—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è -->
                                <div class="right-section">
                                    <button type="button" class="btn btn-link" onclick="toggleDetails(this)">
                                        <i class="bi bi-chevron-down"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–µ -->
                            <div class="card-details" style="display: none; justify-content: space-between; align-items: center;">
                                <div class="left-content">
                                    <div class="card-status" th:if="${card.isPrimary}">
                                        –û—Å–Ω–æ–≤–Ω–∞—è
                                    </div>
                                    <div class="card-status" th:if="${!card.isPrimary}">
                                        <button type="button" class="btn btn-primary btn-sm" th:data-card-id="${card.cardId}" style="background-color: transparent; border: none; color: #007bff; padding: 0;" onclick="setPrimary(this)">
                                            <span style="display: block;">–°–¥–µ–ª–∞—Ç—å</span>
                                            <span style="display: block;">–æ—Å–Ω–æ–≤–Ω–æ–π</span>
                                        </button>
                                    </div>
                                </div>
                                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è -->
                                <div>
                                    <button type="button" class="btn btn-danger btn-sm" th:data-card-id="${card.cardId}" style="background-color: transparent; border: none; color: #dc3545; padding: 0;" onclick="deleteCard(this)">
                                        –£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É
                                    </button>
                                </div>
                            </div>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    –ü—Ä–æ—Ñ–∏–ª—å
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <form th:action="@{/api/profile/update}" method="post" id="profileForm">
                        <!-- –ò–º—è -->
                        <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                            <label for="firstName">–ò–º—è</label>
                            <input type="text" id="firstName" name="firstName" class="form-control" th:value="${profileForm.firstName}" required>
                        </div>

                        <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                            <label for="lastName">–§–∞–º–∏–ª–∏—è</label>
                            <input type="text" id="lastName" name="lastName" class="form-control" th:value="${profileForm.lastName}" required>
                        </div>

                        <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="tel" id="phone" name="phone" class="form-control" th:value="${profileForm.phone}" required pattern="^\+?[0-9]{10,15}$" title="–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                        </div>

                        <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                            <label for="email">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                            <input type="email" id="email" name="email" class="form-control" th:value="${profileForm.email}" required>
                        </div>

                        <div class="mb-3">
                            <label for="dateOfBirth">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                            <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-control"
                                   th:value="${profileForm.dateOfBirth != null ? #temporals.format(profileForm.dateOfBirth, 'yyyy-MM-dd') : ''}">
                            <div class="form-text">–û—á–µ–Ω—å —Ö–æ—á—É –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è üå∏</div>
                        </div>

                        <div class="mb-3">
                            <label for="city">–ì–æ—Ä–æ–¥</label>
                            <input type="text" id="city" name="city" class="form-control" th:value="${profileForm.city}">
                        </div>

                        <div class="mb-3">
                            <label for="profession">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
                            <input type="text" id="profession" name="profession" class="form-control" th:value="${profileForm.profession}">
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                <div class="accordion-body">
                    <div class="transaction-list" id="transactionList">
                        <th:block th:if="${transactions.isEmpty()}">
                            <div class="text-center">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>
                        </th:block>
                        <th:block th:each="transaction : ${transactions}">
                            <div class="transaction-item mb-2">
                                <div class="left-section">
                                    <div class="transaction-type">–ü–æ–¥–ø–∏—Å–∫–∞</div>
                                </div>
                                <div class="right-section">
                                    <div class="amount" th:text="${transaction.amount} + ' ' + ${transaction.currency}"></div>

                                    <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –¥–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–æ–π -->
                                    <div class="date-time"
                                         th:if="${#temporals.format(transaction.dateTime, 'yyyy-MM-dd')} == ${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                                         th:text="${#temporals.format(transaction.dateTime, 'HH:mm')}">
                                    </div>

                                    <!-- –ò–Ω–∞—á–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞—Ç—É -->
                                    <div class="date-time"
                                         th:unless="${#temporals.format(transaction.dateTime, 'yyyy-MM-dd')} == ${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                                         th:text="${#temporals.format(transaction.dateTime, 'dd MMM yyyy')}">
                                    </div>
                                </div>
                            </div>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
        <!-- –¢–æ—Å—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="toast align-items-center" id="deleteToast" role="alert" aria-live="assertive" aria-atomic="true" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1050;">
            <div class="d-flex">
                <div class="toast-body">
                    –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.
                </div>
            </div>
        </div>

    </div>

</div>


<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>
</body>
<th:block th:fragment="scripts">
    <script>
        function toggleDetails(button) {
            const icon = button.querySelector('i');
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å—ã –∏–∫–æ–Ω–∫–∏
            if (icon.classList.contains('bi-chevron-down')) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }


            const cardDetails = button.closest('.transaction-item').nextElementSibling;
            if (cardDetails.style.display === 'none' || cardDetails.style.display === '') {
                cardDetails.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
            } else {
                cardDetails.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º
            }
        }



        function deleteCard(button) {
            const cardId = button.getAttribute('data-card-id');
            fetch(`/api/my/cards/${cardId}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (response.ok) {
                        showToast()
                        location.reload(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    } else {
                        toast.show();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toast.show();
                });
            showToast()
        }
        function showToast() {
            const toast = document.getElementById('deleteToast');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç
            toast.style.display = 'block';

            // –£–±–∏—Ä–∞–µ–º —Ç–æ—Å—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    </script>
    <script th:inline="javascript">
        function setPrimary(button) {
            const cardId = button.getAttribute('data-card-id');
            fetch(`/api/my/cards/${cardId}/set-primary`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (response.ok) {
                        toast.show();
                        location.reload(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    } else {
                        toast.show();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toast.show();
                });
        }

    </script>
    <script th:inline="javascript">
        const form = document.getElementById('profileForm');
        let initialFormDataString = JSON.stringify(Object.fromEntries(new FormData(form).entries()));

        const toastEl = document.getElementById('liveToast');
        const toastMessage = document.getElementById('toastMessage');
        const toast = new bootstrap.Toast(toastEl);

        function isFormChanged() {
            const currentFormDataString = JSON.stringify(Object.fromEntries(new FormData(form).entries()));
            return currentFormDataString !== initialFormDataString;
        }

        function checkFormValidity() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã
            if (!form.checkValidity()) {
                form.reportValidity();
                Bugsnag.notify('Form is not valid');
                return;
            }
        }

        //TODO –¥–æ–±–∞–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–¥–µ–ª–∞—Ç—å async
        function saveData() {
            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/api/profile/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    /* 'X-CSRF-TOKEN': –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å —Ç–æ–∫–µ–Ω CSRF, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è */
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        Telegram.WebApp.MainButton.hide();
                        initialFormDataString = JSON.stringify(data); // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        toastMessage.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.';
                        toast.show();
                    } else {
                        toastMessage.textContent = '‚ùå–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + JSON.stringify(response.body);
                        toast.show();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toastMessage.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error;
                    toast.show();
                });
        }
    </script>
    <script th:inline="javascript" th:if="${firstRun}">
        Telegram.WebApp.isClosingConfirmationEnabled = true;
        Telegram.WebApp.BackButton.hide()
        Telegram.WebApp.MainButton.text = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        Telegram.WebApp.MainButton.hasShineEffect = true;
        Telegram.WebApp.onEvent('mainButtonClicked', function () {
            if (isFormChanged()) {
                checkFormValidity()
                saveData()
                window.location.href = "/onboarding"
            } else {
                let params = {}
                params.title = "–í—ã –∑–∞–ø–æ–ª–Ω–∏–ª–∏ –Ω–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ. üòû"
                params.message = "–ú—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –ª—É—á—à–µ —É–∑–Ω–∞—Ç—å –≤–∞—Å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –≤–∞—à–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –µ—â—ë –±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º. –•–æ—Ç—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –≤–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."
                params.buttons = [{
                    "id": "skip",
                    "type": "default",
                    "text": "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
                }, {
                    "type": "default",
                    "text": "–ó–∞–ø–æ–ª–Ω–∏—Ç—å"
                }]
                Telegram.WebApp.showPopup(params, function (id) {
                    if (id === "skip") {
                        window.location.href = "/onboarding"
                    }
                })
            }
        })
        Telegram.WebApp.MainButton.show();
    </script>
    <script th:inline="javascript" th:if="${!firstRun}">

        Telegram.WebApp.BackButton.onClick(function () {
            window.location.href = "/"
        })

        form.addEventListener('input', function() {
            if (isFormChanged()) {
                Telegram.WebApp.isClosingConfirmationEnabled = true;
                Telegram.WebApp.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è");
                Telegram.WebApp.MainButton.show();
            } else {
                Telegram.WebApp.isClosingConfirmationEnabled = false;
                Telegram.WebApp.MainButton.hide();
            }
        });

        Telegram.WebApp.MainButton.onClick(function () {
            checkFormValidity()
            saveData()
        });

        Telegram.WebApp.BackButton.show();
        Telegram.WebApp.MainButton.hide();
        Telegram.WebApp.SecondaryButton.hide();
    </script>
</th:block>

</html>
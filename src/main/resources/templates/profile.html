<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: template (~{::head}, ~{::body}, ~{::scripts})}">
<head>
    <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-2">
    <h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>
    <div class="card">
        <div class="card-body">
            <form th:action="@{/api/profile/update}" method="post" id="profileForm">
                <!-- –ò–º—è -->
                <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                    <label for="firstName">–ò–º—è</label>
                    <input type="text" id="firstName" name="firstName" class="form-control"
                           th:value="${profileForm.firstName}" required>
                </div>

                <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                    <label for="lastName">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="lastName" name="lastName" class="form-control"
                           th:value="${profileForm.lastName}" required>
                </div>

                <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                    <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="phone" name="phone" class="form-control"
                           th:value="${profileForm.phone}" required
                           pattern="^\+?[0-9]{10,15}$" title="–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                </div>

                <div class="mb-3" th:classappend="${firstRun} ? 'd-none' : ''">
                    <label for="email">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                    <input type="email" id="email" name="email" class="form-control"
                           th:value="${profileForm.email}" required>
                </div>

                <div class="mb-3">
                    <label for="dateOfBirth">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-control"
                           th:value="${profileForm.dateOfBirth != null ? #temporals.format(profileForm.dateOfBirth, 'yyyy-MM-dd') : ''}">
                    <div class="form-text">
                        –û—á–µ–Ω—å —Ö–æ—á—É –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è üå∏
                    </div>
                </div>

                <div class="mb-3">
                    <label for="city">–ì–æ—Ä–æ–¥</label>
                    <input type="text" id="city" name="city" class="form-control"
                           th:value="${profileForm.city}">
                </div>

                <div class="mb-3">
                    <label for="profession">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
                    <input type="text" id="profession" name="profession" class="form-control"
                           th:value="${profileForm.profession}">
                </div>
            </form>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>
</body>
<th:block th:fragment="scripts">
    <script th:inline="javascript">
        const form = document.getElementById('profileForm');
        let initialFormDataString = JSON.stringify(Object.fromEntries(new FormData(form).entries()));

        const toastEl = document.getElementById('liveToast');
        const toastMessage = document.getElementById('toastMessage');
        const toast = new bootstrap.Toast(toastEl);

        function isFormChanged() {
            const currentFormDataString = JSON.stringify(Object.fromEntries(new FormData(form).entries()));
            return currentFormDataString !== initialFormDataString;
        }

        function checkFormValidity() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
        }

        //TODO –¥–æ–±–∞–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–¥–µ–ª–∞—Ç—å async
        function saveData() {
            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/api/profile/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    /* 'X-CSRF-TOKEN': –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å —Ç–æ–∫–µ–Ω CSRF, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è */
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        Telegram.WebApp.MainButton.hide();
                        initialFormDataString = JSON.stringify(data); // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        toastMessage.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.';
                        toast.show();
                    } else {
                        toastMessage.textContent = '‚ùå–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + JSON.stringify(response.body);
                        toast.show();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    toastMessage.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error;
                    toast.show();
                });
        }
    </script>
    <script th:inline="javascript" th:if="${firstRun}">
        Telegram.WebApp.isClosingConfirmationEnabled = true;
        Telegram.WebApp.BackButton.hide()
        Telegram.WebApp.MainButton.text = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        Telegram.WebApp.MainButton.hasShineEffect = true;
         Telegram.WebApp.onEvent('mainButtonClicked', function () {
             if (isFormChanged()) {
                 checkFormValidity()
                 saveData()
                 window.location.href = "/onboarding"
             } else {
                 let params = {}
                 params.title = "–í—ã –∑–∞–ø–æ–ª–Ω–∏–ª–∏ –Ω–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ. üòû"
                 params.message = "–ú—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –ª—É—á—à–µ —É–∑–Ω–∞—Ç—å –≤–∞—Å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –≤–∞—à–µ –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –µ—â—ë –±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º. –•–æ—Ç—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –≤–∞—à–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."
                 params.buttons = [{
                     "id": "skip",
                     "type": "default",
                     "text": "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
                 }, {
                     "type": "default",
                     "text": "–ó–∞–ø–æ–ª–Ω–∏—Ç—å"
                 }]
                 Telegram.WebApp.showPopup(params, function (id) {
                     if (id === "skip") {
                         window.location.href = "/onboarding"
                     }
                 })
             }
         })
        Telegram.WebApp.MainButton.show();
    </script>
    <script th:inline="javascript" th:if="${!firstRun}">

        Telegram.WebApp.BackButton.onClick(function () {
            window.location.href = "/"
        })

        form.addEventListener('input', function() {
            if (isFormChanged()) {
                Telegram.WebApp.isClosingConfirmationEnabled = true;
                Telegram.WebApp.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è");
                Telegram.WebApp.MainButton.show();
            } else {
                Telegram.WebApp.isClosingConfirmationEnabled = false;
                Telegram.WebApp.MainButton.hide();
            }
        });

        Telegram.WebApp.MainButton.onClick(function () {
            checkFormValidity()
            saveData()
        });

        Telegram.WebApp.BackButton.show();
        Telegram.WebApp.MainButton.hide();
        Telegram.WebApp.SecondaryButton.hide();
    </script>
</th:block>

</html>
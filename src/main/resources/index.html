<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата подписки на месяц. Сообщество "Как дома" Юлии Митрохиной</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .hide-scroll {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="hide-scroll">
<script>
    window.Telegram.WebApp.MainButton.hide()
    // Проверка текущего числа
    const today = new Date();
    const day = today.getDate();
    if (window.Telegram.WebApp.initDataUnsafe.user.id === 438139618) {
        console.log("Bypassing admin")
        eruda.init()
    } else if (day < 1 || day > 3) {
        window.location.href = '/unavailable';
    }

    if (typeof window.Telegram === 'undefined' ||
        typeof window.Telegram.WebApp === 'undefined' ||
        typeof window.Telegram.WebApp.initDataUnsafe === 'undefined' ||
        typeof window.Telegram.WebApp.initDataUnsafe.user === 'undefined' ||
        typeof window.Telegram.WebApp.initDataUnsafe.user.id === 'undefined') {
        // Перенаправление на указанную страницу Telegram
        window.location.href = 'https://t.me/fenomen_mitrohina_bot/society';
    }

    var price = 2990.00;
    var pkId = "pk_dc972c529da05acb3a61d5f049cbc";
    var payments = new cp.CloudPayments({
        language: "ru-RU",
        email: "",
        applePaySupport: false,
        googlePaySupport: false,
        yandexPaySupport: false,
        tinkoffPaySupport: false,
        tinkoffInstallmentSupport: false,
        sbpSupport: true,
    });

    var receipt = {
        "Items": [
            {
                "label": "Доступ в сообщество на месяц. Юлия Митрохина",
                "price": price,
                "quantity": 1.00,
                "amount": price,
                "method": 4,
                "object": 4,
                "measurementUnit": "шт"
            }
        ],
        "calculationPlace": "mitrohinayulya.ru",
        "taxationSystem": 1,
        "amounts": {
            "electronic": price,
            "advancePayment": 0.00,
            "credit": 0.00,
            "provision": 0.00
        }
    };

    var data = {
        CloudPayments: {
            CustomerReceipt: receipt
        }
    };

    function initiatePayment() {
        payments.pay("charge", {
                publicId: pkId,
                description: "Оплата подписки на 1 мес. Сообщество \"Как дома\" Юлии Митрохиной",
                amount: price,
                currency: "RUB",
                accountId: window.Telegram.WebApp.initDataUnsafe.user.id,
                invoiceId: "INV" + window.Telegram.WebApp.initDataUnsafe.user.id,
                skin: "mini",
                requireEmail: true,
                data: data
            },
            {
                onSuccess: function (options) { // success
                    window.location.href = "/success";
                },
                onFail: function (reason, options) { // fail
                    window.location.href = "/fail";
                }
            }).then(function (widgetResult) {
            console.log('result', widgetResult);
        }).catch(function (error) {
            console.log('error', error);
        });
    }

    window.addEventListener('load', function () {
        const emailInput = document.querySelector('input[type="email"]');

        if (emailInput) {
            emailInput.addEventListener('input', function () {
                const email = emailInput.value;
                console.log('Email entered:', email);

                // Обновляем поле email в объекте receipt
                receipt.email = email;
            });

            // Запуск платежа после изменения e-mail
            emailInput.addEventListener('change', function () {
                initiatePayment();
            });
        } else {
            console.error('Email input not found');
            initiatePayment(); // Запуск платежа, если поле ввода не найдено
        }
    });
</script>
</body>
</html>